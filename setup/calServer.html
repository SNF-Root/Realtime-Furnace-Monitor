<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rectangle Drawer</title>
  <style>
    body { margin:0; background:#111; color:#eee; font-family:sans-serif; }
    #wrap { padding:12px; }
    #log { white-space:pre; font:12px/1.4 monospace; background:#000; padding:8px; border:1px solid #333; max-height:200px; overflow:auto; }
    canvas { display:block; outline:1px solid #444; background:hsl(0, 0%, 0%); }
    #toolbar { margin:8px 0; display: flex; gap: 10px;}
    button { padding:6px 10px; }

  </style>
</head>
<body>
<div id="wrap">
  <div id="toolbar">
    <button id="clear">Clear All</button>
    <button id="undo">Undo Last</button>
  </div>
  <canvas id="c"></canvas>
  <div id="log"></div>
</div>
<div id="popup" style="
  display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background:#222; padding:16px; border:2px solid #555; z-index:1000;
">
  <div style="display:flex; gap:12px; margin-bottom:12px;">
    <div>
      <div style="text-align:center; color:#ccc;">Control</div>
      <img id="popupControl" src="" style="max-width:300px; border:1px solid #444;">
    </div>
    <div>
      <div style="text-align:center; color:#ccc;">Filtered</div>
      <img id="popupFiltered" src="" style="max-width:300px; border:1px solid #444;">
    </div>
  </div>
  <div style="text-align:center;">
    <button id="popupAccept">Accept</button>
    <button id="popupReject">Reject</button>
  </div>
</div>

</body>



<script>
const cvs = document.getElementById('c');
const ctx = cvs.getContext('2d');
const logEl = document.getElementById('log');
const clearBtn = document.getElementById('clear');
const undoBtn = document.getElementById('undo');


const popup        = document.getElementById("popup");
const imgControl   = document.getElementById("popupControl");
const imgFiltered  = document.getElementById("popupFiltered");
const btnAccept    = document.getElementById("popupAccept");
const btnReject    = document.getElementById("popupReject");





const img = new Image();
let xScale = (1920/1280);
let yScale = (1080/720)
let dragging = false, ix = 0, iy = 0;
let overlayRects = [];

function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

img.onload = () => {
  const maxW = 1280;
  const W = img.naturalWidth, H = img.naturalHeight;
  const viewW = Math.min(maxW, W);
  scale = viewW / W;
  cvs.width = viewW;
  cvs.height = Math.round(H * scale);
  draw();
};
img.src = "/image";


function draw(preview){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#f00";
  overlayRects.forEach(r => ctx.strokeRect(r.x, r.y, r.w, r.h));

  if (preview){
    ctx.lineWidth = 1
    ctx.strokeStyle = "lime";
    ctx.strokeRect(preview.x, preview.y, preview.w, preview.h);
  }
}

cvs.onmousedown = e => {
  const r = cvs.getBoundingClientRect();
  ix = e.clientX - r.left;
  iy = e.clientY - r.top;
  dragging = true;
};

cvs.onmousemove = e => {
  if (!dragging) return;
  const r = cvs.getBoundingClientRect();
  const x = e.clientX - r.left, y = e.clientY - r.top;
  const rx = Math.min(ix, x), ry = Math.min(iy, y);
  const rw = Math.abs(x - ix), rh = Math.abs(y - iy);
  draw({x: rx, y: ry, w: rw, h: rh});
};

function showPopUp({control, filtered, rect}){
  imgControl.src = control + "?" + Date.now()
  imgFiltered.src = filtered + "?" + Date.now()
  popup.style.display = "block"

  btnAccept.onclick = acceptFn;

  btnReject.onclick = rejectFn;


}



cvs.onmouseup = async e => {
  if (!dragging) return;
  dragging = false;

  const r = cvs.getBoundingClientRect();
  const x = e.clientX - r.left, y = e.clientY - r.top;
  const rx = Math.round(Math.min(ix, x)), ry = Math.round(Math.min(iy, y));
  const rw = Math.round(Math.abs(x - ix)), rh = Math.round(Math.abs(y - iy));
  if (rw < 3 || rh < 3){ draw(); return; }

  // original image pixels
  const orig = {
    x: Math.round(rx * xScale),
    y: Math.round(ry * yScale),
    w: Math.round(rw * xScale),
    h: Math.round(rh * yScale),
  };

  console.log(orig)


  overlayRects.push({ x: rx, y: ry, w: rw, h: rh });
  draw();

  // send to server (just prints coords)
  const res = await fetch("/rect", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(orig)
  });
  const j = await res.json();
  console.log(j.control_path)
  console.log(j.filtered_path)

  console.log(overlayRects)

  showPopUp({control: j.control_path, filtered: j.filtered_path, rect: orig})
};


async function acceptFn(){
  popup.style.display = "none"

  imgControl.src = ""
  imgFiltered.src = ""


  const res = await fetch("/accepted", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(overlayRects[overlayRects.length-1])
  })

  const j = await res.json();
  console.log(j)

  btnAccept.onclick = btnReject.onclick = null;
}


function rejectFn(){
  popup.style.display = "none"

  imgControl.src = ""
  imgFiltered.src = ""

  btnAccept.onclick = btnReject.onclick = null;


  overlayRects.pop()
  draw()
}



clearBtn.onclick = async () => { 
  overlayRects = [];
  draw(); 
  const res = await fetch("/cleared_xyz_parrow", {
    method: "POST",
    headers: {"Content-Type": "application/json"}
  })
  
  const j = await res.json()
  console.log(j)
}

undoBtn.onclick = async () => {
  overlayRects.pop()
  draw()
  const res = await fetch("/undo_last", {
    method: "POST",
    headers: {"Content-Type": "application/json "}
  })

  const j = await res.json()
  console.log(j)
}

</script>
</body>
</html>